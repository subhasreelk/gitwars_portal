<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitWars Portal - Public Leaderboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/starwars-theme.css">
</head>
<body>
    <!-- Animated Starfield Background -->
    <div class="starfield">
        <div class="stars"></div>
        <div class="stars stars-layer-2"></div>
        <div class="stars stars-layer-3"></div>
    </div>

    <!-- Flying Objects -->
    <div class="flying-objects-container">
        <div class="flying-object flying-droid">ü§ñ</div>
        <div class="flying-object flying-droid-2">üõ∏</div>
        <div class="flying-object flying-rocket">üöÄ</div>
        <div class="flying-object flying-rocket-2">‚ú®</div>
        <div class="flying-object shooting-star"></div>
        <div class="flying-object shooting-star-2"></div>
        <div class="flying-object shooting-star-3"></div>
        <div class="flying-object mini-asteroid">üí´</div>
        <div class="flying-object flying-droid-3">‚≠ê</div>
    </div>

    <div class="page-wrapper">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1>GitWars Leaderboard</h1>
                <div class="user-info">
                    <span>Viewing as: <span id="username-display" class="username"></span></span>
                    <span class="role-badge role-public">PUBLIC</span>
                    <button id="logout-btn" class="btn btn-logout">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Star Wars Logo -->
            <div class="sw-logo-container">
                <img src="images/starwars-logo.png" alt="Star Wars" class="sw-logo">
            </div>

            <div class="dashboard-content">

                <!-- View Toggle Buttons -->
                <div class="view-toggle-section">
                    <button type="button" id="btn-class-view" class="view-toggle-btn active">Class View</button>
                    <button type="button" id="btn-overall-view" class="view-toggle-btn">Overall View</button>
                </div>

                <!-- Class View (Default) -->
                <section id="class-view" class="leaderboard-section">
                    <!-- Class Selector -->
                    <div class="class-selector">
                        <label for="class-dropdown">Select Class:</label>
                        <select id="class-dropdown">
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                        </select>
                    </div>

                    <!-- Side-by-Side Leaderboards -->
                    <div class="dual-leaderboard">
                        <!-- JEDI Leaderboard -->
                        <div class="leaderboard-panel jedi-panel">
                            <h2 class="panel-title jedi-title">JEDI</h2>
                            <table class="leaderboard-table">
                                <thead>
                                    <tr>
                                        <th class="col-rank">Rank</th>
                                        <th class="col-team-name">Team Name</th>
                                        <th class="col-score">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="jedi-leaderboard-body">
                                    <tr class="empty-row">
                                        <td colspan="3">No JEDI teams</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- SITH Leaderboard -->
                        <div class="leaderboard-panel sith-panel">
                            <h2 class="panel-title sith-title">SITH</h2>
                            <table class="leaderboard-table">
                                <thead>
                                    <tr>
                                        <th class="col-rank">Rank</th>
                                        <th class="col-team-name">Team Name</th>
                                        <th class="col-score">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="sith-leaderboard-body">
                                    <tr class="empty-row">
                                        <td colspan="3">No SITH teams</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Overall View (Hidden by default) -->
                <section id="overall-view" class="leaderboard-section hidden">
                    <h2 class="overall-title">Overall Leaderboard</h2>
                    <div class="table-container">
                        <table class="leaderboard-table overall-table">
                            <thead>
                                <tr>
                                    <th class="col-rank">Rank</th>
                                    <th class="col-team-name">Team Name</th>
                                    <th class="col-class">Class</th>
                                    <th class="col-role">Role</th>
                                    <th class="col-score">Score</th>
                                </tr>
                            </thead>
                            <tbody id="overall-leaderboard-body">
                                <tr class="empty-row">
                                    <td colspan="5">No teams registered</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

            </div>
        </main>

        <!-- ===================== -->
        <!-- PUBLIC TIMER SECTION  -->
        <!-- ===================== -->
        <section class="public-timer-section">
            <div class="public-timer-panel">
                
                <!-- Large Countdown Clock (Centered) -->
                <div class="public-timer-clock-row">
                    <div id="public-timer-display" class="public-timer-display">01:00</div>
                    <div id="public-timer-status" class="public-timer-status">READY</div>
                </div>
                
                <!-- Preset Time Buttons (Single Horizontal Row) -->
                <div class="public-timer-presets-row">
                    <button type="button" class="public-preset-btn" data-seconds="30">30s</button>
                    <button type="button" class="public-preset-btn active" data-seconds="60">1m</button>
                    <button type="button" class="public-preset-btn" data-seconds="90">1:30</button>
                    <button type="button" class="public-preset-btn" data-seconds="120">2m</button>
                    <button type="button" class="public-preset-btn" data-seconds="180">3m</button>
                    <button type="button" class="public-preset-btn" data-seconds="600">10m</button>
                </div>
                
                <!-- Control Buttons (Start / Stop / Reset) -->
                <div class="public-timer-controls-row">
                    <button type="button" id="public-btn-start" class="public-control-btn public-btn-start">Start</button>
                    <button type="button" id="public-btn-stop" class="public-control-btn public-btn-stop" disabled>Stop</button>
                    <button type="button" id="public-btn-reset" class="public-control-btn public-btn-reset">Reset</button>
                </div>
                
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <p>GitWars Portal &copy; 2026</p>
        </footer>
    </div>

    <!-- Page Script -->
    <script type="module">
        import { protectPage, getUsername, clearSession } from "./js/utils.js";
        import { subscribeToTeams } from "./js/teams.js";
        
        // State
        let allTeams = [];
        let currentView = "class"; // "class" or "overall"
        let selectedClass = 1;
        
        // Timer State (LOCAL - not synced)
        let timerInterval = null;      // Interval ID
        let currentSeconds = 60;       // Current countdown value
        let presetSeconds = 60;        // Last selected preset (for reset)
        let isTimerRunning = false;    // Timer running state
        
        // DOM Elements
        const btnClassView = document.getElementById("btn-class-view");
        const btnOverallView = document.getElementById("btn-overall-view");
        const classView = document.getElementById("class-view");
        const overallView = document.getElementById("overall-view");
        const classDropdown = document.getElementById("class-dropdown");
        const jediLeaderboardBody = document.getElementById("jedi-leaderboard-body");
        const sithLeaderboardBody = document.getElementById("sith-leaderboard-body");
        const overallLeaderboardBody = document.getElementById("overall-leaderboard-body");
        
        // Timer DOM Elements
        const publicTimerDisplay = document.getElementById("public-timer-display");
        const publicTimerStatus = document.getElementById("public-timer-status");
        const publicBtnStart = document.getElementById("public-btn-start");
        const publicBtnStop = document.getElementById("public-btn-stop");
        const publicBtnReset = document.getElementById("public-btn-reset");
        const publicPresetButtons = document.querySelectorAll(".public-preset-btn");

        // =====================================================
        // LEADERBOARD ANIMATION SYSTEM
        // Uses FLIP technique for smooth row position changes
        // Triggered by Firestore onSnapshot live updates
        // =====================================================

        // Animation state (per table body) - stores previous ranks
        const rankMemory = new WeakMap();

        /**
         * Check if animations should run based on screen size
         * Disabled on very small screens for performance
         */
        function shouldAnimateRows() {
            return !window.matchMedia("(max-width: 480px)").matches;
        }

        /**
         * Get or create rank state map for a table body
         */
        function getRankState(tbody) {
            if (!rankMemory.has(tbody)) {
                rankMemory.set(tbody, new Map());
            }
            return rankMemory.get(tbody);
        }

        /**
         * Reset rank state when switching views or classes
         */
        function resetRankState(tbody) {
            rankMemory.set(tbody, new Map());
        }

        /**
         * FLIP Step 1: Capture current positions of all rows
         * Uses getBoundingClientRect for accurate positioning
         */
        function captureRowPositions(tbody) {
            const positions = new Map();
            tbody.querySelectorAll("tr.leaderboard-row").forEach((row) => {
                positions.set(row.dataset.teamId, row.getBoundingClientRect());
            });
            return positions;
        }

        /**
         * FLIP Animation: Animate rows from old positions to new positions
         * @param {HTMLElement} tbody - The table body element
         * @param {Map} previousPositions - Map of teamId -> previous DOMRect
         * @param {Map} rankState - Map of teamId -> previous rank number
         */
        function applyFlipAnimation(tbody, previousPositions, rankState) {
            const rows = Array.from(tbody.querySelectorAll("tr.leaderboard-row"));
            
            rows.forEach((row, index) => {
                const key = row.dataset.teamId;
                const previousRect = previousPositions.get(key);
                const newRect = row.getBoundingClientRect();
                const previousRank = rankState.get(key);
                const newRank = index + 1;

                // Check if row position changed
                const hasMoved = previousRect && 
                    (Math.abs(previousRect.top - newRect.top) > 1 || 
                     Math.abs(previousRect.left - newRect.left) > 1);

                if (hasMoved) {
                    // Calculate the delta (FLIP: Invert)
                    const deltaY = previousRect.top - newRect.top;

                    // Apply inverse transform immediately (no transition)
                    row.style.transition = "none";
                    row.style.transform = `translateY(${deltaY}px)`;
                    row.style.zIndex = "50";

                    // Apply visual feedback classes
                    row.classList.remove("rank-up", "rank-down");
                    if (previousRank && previousRank !== newRank) {
                        row.classList.add(previousRank > newRank ? "rank-up" : "rank-down");
                    }

                    // Force reflow to ensure transform is applied
                    row.offsetHeight;

                    // Animate to final position (FLIP: Play)
                    requestAnimationFrame(() => {
                        row.style.transition = "transform 0.5s ease-in-out";
                        row.style.transform = "translateY(0)";
                    });

                    // Clean up after animation
                    setTimeout(() => {
                        row.style.transition = "";
                        row.style.transform = "";
                        row.style.zIndex = "";
                    }, 550);

                    // Remove glow classes after visible duration
                    setTimeout(() => {
                        row.classList.remove("rank-up", "rank-down");
                    }, 1500);
                }

                // Always update rank state
                rankState.set(key, newRank);
            });
        }

        /**
         * Render table with FLIP animation support
         * @param {HTMLElement} tbody - The table body to render into
         * @param {Array} teams - Sorted array of team objects
         * @param {Function} buildRow - Function to build row innerHTML
         */
        function renderTableWithAnimation(tbody, teams, buildRow) {
            if (teams.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="${tbody.dataset.columns || 3}">No teams registered</td>
                    </tr>
                `;
                resetRankState(tbody);
                return;
            }

            const animate = shouldAnimateRows();
            const previousPositions = animate ? captureRowPositions(tbody) : null;
            const rankState = getRankState(tbody);

            // Build document fragment for efficient DOM updates
            const fragment = document.createDocumentFragment();

            teams.forEach((team, index) => {
                // Reuse existing row if present, otherwise create new
                let row = tbody.querySelector(`tr[data-team-id="${team.id}"]`);
                if (!row) {
                    row = document.createElement("tr");
                    row.className = "leaderboard-row";
                }

                // Set data attributes for identification
                row.dataset.teamId = team.id;
                row.dataset.role = team.role;
                row.dataset.teamClass = team.class;

                // Build row content
                buildRow(row, team, index);
                fragment.appendChild(row);
            });

            // Clear and append new content
            tbody.innerHTML = "";
            tbody.appendChild(fragment);

            // Apply FLIP animation if enabled
            if (animate && previousPositions && previousPositions.size > 0) {
                requestAnimationFrame(() => {
                    applyFlipAnimation(tbody, previousPositions, rankState);
                });
            } else {
                // Just update rank state without animation
                teams.forEach((team, index) => {
                    rankState.set(team.id, index + 1);
                });
            }
        }
        
        /**
         * Sort teams by score (descending)
         */
        function sortByScore(teams) {
            return [...teams].sort((a, b) => b.score - a.score);
        }
        
        /**
         * Render the Class View leaderboards (JEDI vs SITH)
         */
        function renderClassView() {
            // Filter teams by selected class
            const classTeams = allTeams.filter(team => team.class === selectedClass);
            
            // Separate JEDI and SITH
            const jediTeams = sortByScore(classTeams.filter(team => team.role === "JEDI"));
            const sithTeams = sortByScore(classTeams.filter(team => team.role === "SITH"));
            
            // Render JEDI leaderboard
            renderLeaderboardPanel(jediLeaderboardBody, jediTeams, "JEDI");
            
            // Render SITH leaderboard
            renderLeaderboardPanel(sithLeaderboardBody, sithTeams, "SITH");
        }
        
        /**
         * Render a single leaderboard panel (JEDI or SITH)
         */
        function renderLeaderboardPanel(tbody, teams, role) {
            if (teams.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="3">No ${role} teams in Class ${selectedClass}</td>
                    </tr>
                `;
                resetRankState(tbody);
                return;
            }

            tbody.dataset.columns = 3;

            renderTableWithAnimation(tbody, teams, (row, team, index) => {
                row.innerHTML = `
                    <td class="col-rank">${index + 1}</td>
                    <td class="col-team-name">${team.teamName}</td>
                    <td class="col-score">${team.score}</td>
                `;
            });
        }
        
        /**
         * Render the Overall View leaderboard
         */
        function renderOverallView() {
            // Sort all teams by score
            const sortedTeams = sortByScore(allTeams);

            overallLeaderboardBody.dataset.columns = 5;

            renderTableWithAnimation(overallLeaderboardBody, sortedTeams, (row, team, index) => {
                const roleClass = team.role === "JEDI" ? "role-jedi" : "role-sith";
                row.innerHTML = `
                    <td class="col-rank">${index + 1}</td>
                    <td class="col-team-name">${team.teamName}</td>
                    <td class="col-class">${team.class}</td>
                    <td class="col-role ${roleClass}">${team.role}</td>
                    <td class="col-score">${team.score}</td>
                `;
            });
        }
        
        /**
         * Render the appropriate view based on current state
         */
        function renderLeaderboard() {
            if (currentView === "class") {
                renderClassView();
            } else {
                renderOverallView();
            }
        }
        
        /**
         * Switch to Class View
         */
        function showClassView() {
            currentView = "class";
            
            // Update toggle buttons
            btnClassView.classList.add("active");
            btnOverallView.classList.remove("active");
            
            // Show/hide sections
            classView.classList.remove("hidden");
            overallView.classList.add("hidden");
            
            renderClassView();
        }
        
        /**
         * Switch to Overall View
         */
        function showOverallView() {
            currentView = "overall";
            
            // Update toggle buttons
            btnOverallView.classList.add("active");
            btnClassView.classList.remove("active");
            
            // Show/hide sections
            overallView.classList.remove("hidden");
            classView.classList.add("hidden");
            
            renderOverallView();
        }
        
        /**
         * Handle class dropdown change
         */
        function handleClassChange() {
            selectedClass = parseInt(classDropdown.value, 10);
            resetRankState(jediLeaderboardBody);
            resetRankState(sithLeaderboardBody);
            renderClassView();
        }
        
        /* ========================
           TIMER FUNCTIONS (LOCAL)
        ======================== */
        
        /**
         * Format seconds to MM:SS string
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return minutes.toString().padStart(2, "0") + ":" + seconds.toString().padStart(2, "0");
        }
        
        /**
         * Update the timer display
         */
        function updateTimerDisplay() {
            publicTimerDisplay.textContent = formatTime(currentSeconds);
            
            // Warning class when time is low
            if (currentSeconds <= 10 && currentSeconds > 0) {
                publicTimerDisplay.classList.add("timer-warning");
            } else {
                publicTimerDisplay.classList.remove("timer-warning");
            }
            
            // Finished class when time is up
            if (currentSeconds === 0) {
                publicTimerDisplay.classList.add("timer-finished");
            } else {
                publicTimerDisplay.classList.remove("timer-finished");
            }
        }
        
        /**
         * Update timer status text
         */
        function setTimerStatus(status) {
            publicTimerStatus.textContent = status;
            publicTimerStatus.className = "public-timer-status";
            
            if (status === "RUNNING") {
                publicTimerStatus.classList.add("status-running");
            } else if (status === "PAUSED") {
                publicTimerStatus.classList.add("status-paused");
            } else if (status === "TIME UP!") {
                publicTimerStatus.classList.add("status-finished");
            }
        }
        
        /**
         * Update timer button states
         */
        function updateTimerButtons() {
            if (isTimerRunning) {
                publicBtnStart.disabled = true;
                publicBtnStop.disabled = false;
                publicBtnReset.disabled = true;
            } else {
                publicBtnStart.disabled = currentSeconds === 0;
                publicBtnStop.disabled = true;
                publicBtnReset.disabled = false;
            }
        }
        
        /**
         * Start the timer countdown
         */
        function startTimer() {
            if (isTimerRunning || currentSeconds <= 0) return;
            
            isTimerRunning = true;
            setTimerStatus("RUNNING");
            updateTimerButtons();
            
            // Clear any existing interval (safety)
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                currentSeconds--;
                updateTimerDisplay();
                
                if (currentSeconds <= 0) {
                    stopTimer();
                    setTimerStatus("TIME UP!");
                }
            }, 1000);
        }
        
        /**
         * Stop (pause) the timer
         */
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            isTimerRunning = false;
            
            if (currentSeconds > 0) {
                setTimerStatus("PAUSED");
            }
            
            updateTimerButtons();
        }
        
        /**
         * Reset the timer to last preset value
         */
        function resetTimer() {
            stopTimer();
            currentSeconds = presetSeconds;
            updateTimerDisplay();
            setTimerStatus("READY");
            updateTimerButtons();
        }
        
        /**
         * Set timer to a preset value
         */
        function setTimerPreset(seconds, btn) {
            stopTimer();
            presetSeconds = seconds;
            currentSeconds = seconds;
            
            // Update active button state
            publicPresetButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            
            updateTimerDisplay();
            setTimerStatus("READY");
            updateTimerButtons();
        }
        
        /**
         * Handle preset button clicks
         */
        function handlePresetClick(event) {
            const btn = event.target.closest(".public-preset-btn");
            if (!btn) return;
            
            const seconds = parseInt(btn.dataset.seconds, 10);
            if (!isNaN(seconds) && seconds > 0) {
                setTimerPreset(seconds, btn);
            }
        }
        
        /**
         * Setup timer event listeners
         */
        function setupTimerListeners() {
            publicBtnStart.addEventListener("click", startTimer);
            publicBtnStop.addEventListener("click", stopTimer);
            publicBtnReset.addEventListener("click", resetTimer);
            
            // Use updated class name for presets row
            const presetsContainer = document.querySelector(".public-timer-presets-row");
            if (presetsContainer) {
                presetsContainer.addEventListener("click", handlePresetClick);
            }
        }
        
        /**
         * Setup event listeners
         */
        function setupEventListeners() {
            // View toggle buttons
            btnClassView.addEventListener("click", showClassView);
            btnOverallView.addEventListener("click", showOverallView);
            
            // Class dropdown
            classDropdown.addEventListener("change", handleClassChange);
            
            // Timer controls
            setupTimerListeners();
            
            // Logout button
            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", () => {
                    clearSession();
                    window.location.href = "login.html";
                });
            }
        }
        
        /**
         * Initialize public page
         */
        function initPublicPage() {
            // Check page protection - only PUBLIC role can access
            if (!protectPage("PUBLIC")) {
                return; // Will redirect to login
            }
            
            // Display username
            const usernameDisplay = document.getElementById("username-display");
            if (usernameDisplay) {
                usernameDisplay.textContent = getUsername();
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize timer display
            updateTimerDisplay();
            updateTimerButtons();
            
            // Subscribe to real-time team updates
            subscribeToTeams((teams) => {
                allTeams = teams;
                renderLeaderboard();
            });
            
            console.log("Public leaderboard initialized.");
        }
        
        // Initialize when DOM is ready
        document.addEventListener("DOMContentLoaded", initPublicPage);
    </script>
</body>
</html>
